name: Deploy Review Apps

on:
  # Run this workflow on every PR event. Existing review apps will be updated when the PR is updated.
  pull_request:
    types: [opened, reopened, synchronize, closed]

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  # Match the region with production apps
  FLY_REGION: syd
  FLY_ORG: personal
  # Review app names and URLs (reused throughout the workflow)
  UI_APP_NAME: tau-ui-pr-${{ github.event.number }}
  API_APP_NAME: tau-api-pr-${{ github.event.number }}
  UI_REVIEW_URL: https://tau-ui-pr-${{ github.event.number }}.fly.dev
  API_REVIEW_URL: https://tau-api-pr-${{ github.event.number }}.fly.dev

jobs:
  review_app_ui:
    name: Deploy UI Review App
    runs-on: ubuntu-latest
    # Skip Dependabot PRs
    if: github.actor != 'dependabot[bot]'
    permissions:
      pull-requests: write
      contents: read
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    # Only run one deployment at a time per PR for UI.
    # Cancel in-progress runs when a new commit is pushed to the same PR
    concurrency:
      group: pr-${{ github.event.number }}-ui
      cancel-in-progress: true

    # Deploying apps with this "review" environment allows the URL for the app to be displayed in the PR UI.
    environment:
      name: review-ui
      # The script in the `deploy` sets the URL output for each review app.
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Get code
        uses: actions/checkout@v6

      - name: Post initial UI status
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-ui
          message: |
            ### UI Preview :balloon:
            **Status:** ${{ github.event.action == 'closed' && 'üóëÔ∏è Destroying...' || 'üîÑ Deploying...' }}
            **URL:** ${{ env.UI_REVIEW_URL }}/

      - name: Deploy UI PR app to Fly.io
        id: deploy
        continue-on-error: true
        uses: superfly/fly-pr-review-apps@1.5.0
        with:
          name: ${{ env.UI_APP_NAME }}
          region: syd
          config: apps/ui/fly.toml
          secrets: TAU_API_URL=${{ env.API_REVIEW_URL }} TAU_FRONTEND_URL=${{ env.UI_REVIEW_URL }}

      - name: Update UI status - success
        if: steps.deploy.outcome == 'success'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-ui
          message: |
            ### UI Preview :balloon:
            **Status:** ${{ github.event.action == 'closed' && '‚úÖ Destroyed' || '‚úÖ Deployed' }}
            **URL:** ${{ github.event.action == 'closed' && '_Review app destroyed_' || format('{0}/', env.UI_REVIEW_URL) }}

      - name: Update UI status - failure
        if: steps.deploy.outcome == 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-ui
          message: |
            ### UI Preview :balloon:
            **Status:** ‚ùå Deployment Failed
            **URL:** ${{ env.UI_REVIEW_URL }}/

      - name: Update UI status - cancelled
        if: steps.deploy.outcome == 'cancelled'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-ui
          message: |
            ### UI Preview :balloon:
            **Status:** ‚ö†Ô∏è Deployment Cancelled
            **URL:** ${{ env.UI_REVIEW_URL }}/

      - name: Fail job if deployment failed
        if: steps.deploy.outcome == 'failure' || steps.deploy.outcome == 'cancelled'
        run: exit 1

  review_app_api:
    name: Deploy API Review App
    runs-on: ubuntu-latest
    # Skip Dependabot PRs
    if: github.actor != 'dependabot[bot]'
    permissions:
      pull-requests: write
      contents: read
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    # Only run one deployment at a time per PR for API.
    # Cancel in-progress runs when a new commit is pushed to the same PR
    concurrency:
      group: pr-${{ github.event.number }}-api
      cancel-in-progress: true

    environment:
      name: review-api
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Get code
        uses: actions/checkout@v6

      - name: Post initial API status
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-api
          message: |
            ### API Preview :octopus:
            **Status:** ${{ github.event.action == 'closed' && 'üóëÔ∏è Destroying...' || 'üîÑ Deploying...' }}
            **URL:** ${{ env.API_REVIEW_URL }}

      - name: Deploy API PR app to Fly.io
        id: deploy
        continue-on-error: true
        uses: superfly/fly-pr-review-apps@1.5.0
        with:
          name: ${{ env.API_APP_NAME }}
          region: syd
          config: apps/api/fly.toml
          secrets: TAU_FRONTEND_URL=${{ env.UI_REVIEW_URL }} AUTH_URL=${{ env.API_REVIEW_URL }} ADDITIONAL_CORS_ORIGINS=["${{ env.UI_REVIEW_URL }}"]

      - name: Update API status - success
        if: steps.deploy.outcome == 'success'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-api
          message: |
            ### API Preview :octopus:
            **Status:** ${{ github.event.action == 'closed' && '‚úÖ Destroyed' || '‚úÖ Deployed' }}
            **URL:** ${{ github.event.action == 'closed' && '_Review app destroyed_' || env.API_REVIEW_URL }}

      - name: Update API status - failure
        if: steps.deploy.outcome == 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-api
          message: |
            ### API Preview :octopus:
            **Status:** ‚ùå Deployment Failed
            **URL:** ${{ env.API_REVIEW_URL }}

      - name: Update API status - cancelled
        if: steps.deploy.outcome == 'cancelled'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-api
          message: |
            ### API Preview :octopus:
            **Status:** ‚ö†Ô∏è Deployment Cancelled
            **URL:** ${{ env.API_REVIEW_URL }}

      - name: Fail job if deployment failed
        if: steps.deploy.outcome == 'failure' || steps.deploy.outcome == 'cancelled'
        run: exit 1
