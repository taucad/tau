name: Deploy Review Apps

on:
  # Run this workflow on every PR event. Existing review apps will be updated when the PR is updated.
  pull_request:
    types: [opened, reopened, synchronize, closed]

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  # Match the region with production apps
  FLY_REGION: syd
  FLY_ORG: personal

jobs:
  review_app_ui:
    name: Deploy UI Review App
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    # Only run one deployment at a time per PR for UI.
    # Cancel in-progress runs when a new commit is pushed to the same PR
    concurrency:
      group: pr-${{ github.event.number }}-ui
      cancel-in-progress: true

    # Deploying apps with this "review" environment allows the URL for the app to be displayed in the PR UI.
    environment:
      name: review-ui
      # The script in the `deploy` sets the URL output for each review app.
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Get code
        uses: actions/checkout@v5

      - name: Get previous comment
        uses: marocchino/sticky-pull-request-comment@v2
        id: get-comment
        with:
          header: fly-review-ui
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract existing URL
        id: extract-url
        if: github.event.action == 'synchronize'
        env:
          COMMENT_BODY: ${{ steps.get-comment.outputs.body }}
        run: |
          if [[ "$COMMENT_BODY" =~ \*\*URL:\*\*[[:space:]]*(https://[^[:space:]]*) ]]; then
            echo "url=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "url=" >> $GITHUB_OUTPUT
          fi

      - name: Post initial UI status
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-ui
          message: |
            ### UI Preview :balloon:
            **Status:** ${{ github.event.action == 'closed' && 'üóëÔ∏è Destroying...' || (github.event.action == 'synchronize' && 'üîÑ Redeploying...') || 'üîÑ Deploying...' }}
            **URL:** ${{ steps.extract-url.outputs.url || '_Pending..._' }}

      - name: Deploy UI PR app to Fly.io
        id: deploy
        continue-on-error: true
        uses: superfly/fly-pr-review-apps@1.2.1
        with:
          name: tau-ui-pr-${{ github.event.number }}
          region: syd
          config: apps/ui/fly.toml

      - name: Update UI status - success
        if: steps.deploy.outcome == 'success'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-ui
          message: |
            ### UI Preview :balloon:
            **Status:** ${{ github.event.action == 'closed' && '‚úÖ Destroyed' || '‚úÖ Deployed' }}
            **URL:** ${{ github.event.action == 'closed' && '_Review app destroyed_' || steps.deploy.outputs.url }}

      - name: Update UI status - failure
        if: steps.deploy.outcome == 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-ui
          message: |
            ### UI Preview :balloon:
            **Status:** ‚ùå Deployment Failed
            **URL:** _Failed to deploy_

      - name: Update UI status - cancelled
        if: steps.deploy.outcome == 'cancelled'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-ui
          message: |
            ### UI Preview :balloon:
            **Status:** ‚ö†Ô∏è Deployment Cancelled
            **URL:** _Deployment was cancelled_

      - name: Fail job if deployment failed
        if: steps.deploy.outcome == 'failure' || steps.deploy.outcome == 'cancelled'
        run: exit 1

  review_app_api:
    name: Deploy API Review App
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    # Only run one deployment at a time per PR for API.
    # Cancel in-progress runs when a new commit is pushed to the same PR
    concurrency:
      group: pr-${{ github.event.number }}-api
      cancel-in-progress: true

    environment:
      name: review-api
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Get code
        uses: actions/checkout@v5

      - name: Get previous comment
        uses: marocchino/sticky-pull-request-comment@v2
        id: get-comment
        with:
          header: fly-review-api
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract existing URL
        id: extract-url
        if: github.event.action == 'synchronize'
        env:
          COMMENT_BODY: ${{ steps.get-comment.outputs.body }}
        run: |
          if [[ "$COMMENT_BODY" =~ \*\*URL:\*\*[[:space:]]*(https://[^[:space:]]*) ]]; then
            echo "url=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "url=" >> $GITHUB_OUTPUT
          fi

      - name: Post initial API status
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-api
          message: |
            ### API Preview :octopus:
            **Status:** ${{ github.event.action == 'closed' && 'üóëÔ∏è Destroying...' || (github.event.action == 'synchronize' && 'üîÑ Redeploying...') || 'üîÑ Deploying...' }}
            **URL:** ${{ steps.extract-url.outputs.url || '_Pending..._' }}

      - name: Deploy API PR app to Fly.io
        id: deploy
        continue-on-error: true
        uses: superfly/fly-pr-review-apps@1.2.1
        with:
          name: tau-api-pr-${{ github.event.number }}
          region: syd
          config: apps/api/fly.toml

      - name: Update API status - success
        if: steps.deploy.outcome == 'success'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-api
          message: |
            ### API Preview :octopus:
            **Status:** ${{ github.event.action == 'closed' && '‚úÖ Destroyed' || '‚úÖ Deployed' }}
            **URL:** ${{ github.event.action == 'closed' && '_Review app destroyed_' || steps.deploy.outputs.url }}

      - name: Update API status - failure
        if: steps.deploy.outcome == 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-api
          message: |
            ### API Preview :octopus:
            **Status:** ‚ùå Deployment Failed
            **URL:** _Failed to deploy_

      - name: Update API status - cancelled
        if: steps.deploy.outcome == 'cancelled'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: fly-review-api
          message: |
            ### API Preview :octopus:
            **Status:** ‚ö†Ô∏è Deployment Cancelled
            **URL:** _Deployment was cancelled_

      - name: Fail job if deployment failed
        if: steps.deploy.outcome == 'failure' || steps.deploy.outcome == 'cancelled'
        run: exit 1
