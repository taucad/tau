# Tau API

Backend API service for Tau CAD, built with NestJS and Better Auth.

## Better Auth Schema Generation

The API uses [Better Auth](https://www.better-auth.com/) for authentication, which requires database schema generation from the auth configuration.

### Schema Generation Workflow

To generate and apply the Better Auth schema:

```bash
# Step 1: Generate the schema
pnpm nx auth-schema-generate api

# Or directly with Better Auth CLI
cd apps/api
npx @better-auth/cli generate --config app/config/auth.ts --output app/database/auth-schema.ts --yes
```

**Step 2: Copy changes to main schema**

After generation, manually copy the auth tables from `app/database/auth-schema.ts` to `app/database/schema.ts`:

- Copy: `user`, `session`, `account`, `verification`, and any plugin tables (e.g., `apikey`)
- Preserve: Custom application tables in `schema.ts` (e.g., `build`)

⚠️ **Important**: `auth-schema.ts` is auto-generated and should not be used directly. It serves as a reference that you manually sync to `schema.ts`.

### Configuration Files

- **`app/config/auth.ts`** - Static Better Auth configuration used by the CLI for schema generation
- **`app/config/better-auth.config.ts`** - Runtime configuration that extends the static config with environment-specific values
- **`app/database/auth-schema.ts`** - Auto-generated reference schema (regenerated by CLI, manually sync to `schema.ts`)
- **`app/database/schema.ts`** - Main database schema used by the application (includes auth tables + custom tables)

### Plugin Synchronization

**Important**: When adding or removing Better Auth plugins, you must update plugin declarations in BOTH files:

- **`app/config/auth.ts`** - Default plugin config for CLI schema generation
- **`app/config/better-auth.config.ts`** - Runtime plugin config with custom options

The runtime config includes validation that will throw a clear error if the plugin counts don't match, helping catch sync issues during development.

### When to Regenerate

The schema should be manually regenerated and synced when:

1. Adding new Better Auth plugins (e.g., `apiKey`, `magicLink`, `twoFactor`)
2. Changing authentication configuration in `auth.ts`
3. After updating the `better-auth` package version

Remember to generate the schema, then manually copy changes to `schema.ts` before generating database migrations.

## Database Commands

### Migrations

```bash
# Generate Drizzle migrations from schema changes
pnpm nx db-generate api

# Run migrations against the database
pnpm nx db-migrate api
```

### Database Management

```bash
# Push schema changes directly to database (development only)
pnpm nx db-push api

# Open Drizzle Studio to inspect/edit database
pnpm nx db-studio api
```

## Development

### Setup

```bash
# Copy environment variables
pnpm nx setup-env api

# Start development server
pnpm nx serve api
```

### Building

```bash
# Build for production
pnpm nx build api
```

### Deployment

```bash
# Deploy to Fly.io
pnpm nx deploy api

# Initial Fly.io setup
pnpm nx launch api
```

## Project Structure

```
apps/api/
├── app/
│   ├── api/           # API routes and controllers
│   ├── auth/          # Authentication module
│   ├── config/        # Configuration files
│   │   ├── auth.ts                    # Static Better Auth config
│   │   └── better-auth.config.ts      # Runtime Better Auth config
│   ├── database/      # Database schemas and migrations
│   │   ├── auth-schema.ts             # Generated Better Auth schema
│   │   ├── schema.ts                  # Custom database schemas
│   │   └── migrations/                # Drizzle migrations
│   ├── logger/        # Logging utilities
│   ├── types/         # TypeScript types
│   └── utils/         # Utility functions
├── Dockerfile         # Docker configuration
├── fly.toml          # Fly.io deployment config
└── vite.config.ts    # Vite build configuration
```

## Additional Resources

- [Better Auth Documentation](https://www.better-auth.com/)
- [Drizzle ORM Documentation](https://orm.drizzle.team/)
- [NestJS Documentation](https://nestjs.com/)

