# Netlify configuration for Tau UI
# 
# Environment Variables:
# Production values are set below in [context.production.environment]
# - TAU_API_URL: Set to https://api.tau.new (production)
# - TAU_FRONTEND_URL: Set to https://tau.new (production)
#
# For branch/preview deploys, TAU_FRONTEND_URL is auto-extracted at runtime from
# NETLIFY_AI_GATEWAY_URL (apps/ui/app/config.ts removes the /.netlify/ai suffix)
#
# Netlify auto-provides these system variables:
# - NETLIFY_AI_GATEWAY_URL: Runtime - AI gateway URL (contains deployment URL)
# Build-time variables:
# - CONTEXT: Deploy context (production, deploy-preview, branch-deploy)
# - NETLIFY: Set to "true" when building on Netlify
# - NODE_ENV: Set below per context

[build]
  command = "pnpm nx build ui"
  publish = "apps/ui/build/client"

# Production context (main branch)
[context.production]
  command = "pnpm nx build ui"
  [context.production.environment]
    NODE_ENV = "production"
    TAU_API_URL = "https://api.tau.new"
    TAU_FRONTEND_URL = "https://tau.new"

# Deploy preview context (pull requests)
[context.deploy-preview]
  command = "pnpm nx build ui"
  [context.deploy-preview.environment]
    NODE_ENV = "production"
    TAU_API_URL = "https://api.tau.new"
    # TAU_FRONTEND_URL not set - will use NETLIFY_AI_GATEWAY_URL

# Branch deploy context (non-production branches)
[context.branch-deploy]
  command = "pnpm nx build ui"
  [context.branch-deploy.environment]
    NODE_ENV = "production"
    TAU_API_URL = "https://api.tau.new"
    # TAU_FRONTEND_URL not set - will use NETLIFY_AI_GATEWAY_URL

# Local development configuration (for Netlify Dev)
[dev]
  command = "pnpm nx dev ui"
  targetPort = 3000
  autoLaunch = false
  [dev.environment]
    NODE_ENV = "development"
    TAU_API_URL = "http://localhost:4000"
    TAU_FRONTEND_URL = "http://localhost:3000"

[[headers]]
  for = "/*"
  [headers.values]
    # XSS Protection
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    
    # Clickjacking Protection
    X-Frame-Options = "DENY"
    
    # HSTS (forces HTTPS)
    Strict-Transport-Security = "max-age=63072000; includeSubDomains; preload"
    
    # Referrer Policy
    Referrer-Policy = "strict-origin-when-cross-origin"
    
    # Permissions Policy (Feature Policy)
    Permissions-Policy = "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), interest-cohort=()"
    
    # Cross-Origin Policies
    Cross-Origin-Opener-Policy = "same-origin"
    Cross-Origin-Resource-Policy = "same-origin"
    Cross-Origin-Embedder-Policy = "credentialless"
    
    # JavaScript Profiling
    Document-Policy = "js-profiling"
    
    # Content Security Policy (CSP) - Start with report-only mode
    # NOTE: Test thoroughly before switching to enforcing mode
    # Remove '-Report-Only' suffix to enforce
    Content-Security-Policy-Report-Only = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; font-src 'self' data:; connect-src 'self' https://api.zoo.dev https://api.kittycad.io wss:; worker-src 'self' blob:; child-src 'self' blob:; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;"
